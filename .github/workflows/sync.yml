name: Shopify Mediven Sync

on:
  schedule:
    - cron: '0 * * * *' # Se ejecuta cada hora
  workflow_dispatch:   # Permite ejecutarlo manualmente

# IMPORTANTE: Damos permiso al robot para guardar cambios en el repositorio
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del c칩digo
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          # AGREGAMOS: google-genai (para la IA), rich (para logs) y ShopifyAPI
          pip install requests pandas openpyxl python-dotenv google-genai rich ShopifyAPI

      - name: Ejecutar Sincronizaci칩n Completa (Sync + IA)
        env:
          SHOP_DOMAIN: ${{ secrets.SHOP_DOMAIN }}
          SHOPIFY_ADMIN_TOKEN: ${{ secrets.SHOPIFY_ADMIN_TOKEN }}
          MEDIVEN_USER: ${{ secrets.MEDIVEN_USER }}
          MEDIVEN_PASS: ${{ secrets.MEDIVEN_PASS }}
          SHOPIFY_LOCATION_ID: ${{ secrets.SHOPIFY_LOCATION_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SIMULATE: "false"
          DELETE_MISSING: "true"
        # CAMBIO CLAVE: Ejecutamos sync.py (el orquestador), NO sync_diagnostico
        run: python sync.py

      # NUEVO PASO CR칈TICO: Guardar lo que gener칩 la IA
      # Esto hace un "git commit & push" autom치tico del JSON actualizado
      - name: Guardar memoria de IA en el repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "游뱄 IA: Nuevos productos generados autom치ticamente"
          file_pattern: 'data/diccionario_ia.json'

      - name: Guardar Reporte Excel
        if: always() 
        uses: actions/upload-artifact@v4
        with:
          name: reporte-sincronizacion
          path: reportes/*.xlsx 
          retention-days: 7
