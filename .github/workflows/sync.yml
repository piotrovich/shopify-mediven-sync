name: Shopify Mediven Sync

on:
  schedule:
    - cron: '14 * * * *' # Se ejecuta en el minuto 14 de cada hora (evita el embotellamiento de GitHub)
  workflow_dispatch:   # Permite ejecutarlo manualmente

# IMPORTANTE: Damos permiso al robot para guardar cambios en el repositorio
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del c칩digo
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          # AGREGAMOS: google-genai (IA), rich (logs), ShopifyAPI y Pillow (Im치genes)
          pip install requests pandas openpyxl python-dotenv google-genai rich ShopifyAPI Pillow

      - name: Ejecutar Sincronizaci칩n Completa (Sync + IA + Im치genes)
        env:
          SHOP_DOMAIN: ${{ secrets.SHOP_DOMAIN }}
          SHOPIFY_ADMIN_TOKEN: ${{ secrets.SHOPIFY_ADMIN_TOKEN }}
          MEDIVEN_USER: ${{ secrets.MEDIVEN_USER }}
          MEDIVEN_PASS: ${{ secrets.MEDIVEN_PASS }}
          SHOPIFY_LOCATION_ID: ${{ secrets.SHOPIFY_LOCATION_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # --- NUEVAS VARIABLES PARA EL MOTOR DE IM츼GENES ---
          SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
          SHOPIFY_DEFAULT_IMAGE_URL: ${{ secrets.SHOPIFY_DEFAULT_IMAGE_URL }}
          # --------------------------------------------------
          SIMULATE: "false"
          DELETE_MISSING: "true"
        # Ejecutamos sync.py (el orquestador)
        run: python sync.py

      # NUEVO PASO CR칈TICO: Guardar lo que gener칩 la IA y el Historial de Im치genes
      # Esto hace un "git commit & push" autom치tico de LOS DOS archivos JSON
      - name: Guardar memoria de IA e Im치genes en el repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "游뱄 IA/IMG: Memoria actualizada (Textos + Im치genes)"
          file_pattern: 'data/diccionario_ia.json data/registro_imagenes.json'

      - name: Guardar Reporte Excel
        if: always() 
        uses: actions/upload-artifact@v4
        with:
          name: reporte-sincronizacion
          path: reportes/*.xlsx 
          retention-days: 7
